@* @model FlashCard.Models.Flashcard

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Flashcard</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="CardId" />
            <div class="form-group">
                <label asp-for="FrontFlash" class="control-label"></label>
                <input asp-for="FrontFlash" class="form-control" />
                <span asp-validation-for="FrontFlash" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="BackFlash" class="control-label"></label>
                <input asp-for="BackFlash" class="form-control" />
                <span asp-validation-for="BackFlash" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="UserId" class="control-label"></label>
                <label asp-for="UserId" class="control-label" asp-items="ViewBag.UserId"></label>
            </div>
            <div class="form-group">
                <label asp-for="DeckId" class="control-label"></label>
                <select asp-for="DeckId" class="form-control" asp-items="ViewBag.DeckId"></select>
                <span asp-validation-for="DeckId" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
} *@
@model FlashCard.Models.Flashcard

<h2>Chỉnh sửa Flashcard</h2>

<form asp-action="Edit" method="post">
    <input type="hidden" asp-for="CardId" />
    <input type="hidden" asp-for="UserId" />

    <div class="form-group">
        <label asp-for="CardTitle"></label>
        <input asp-for="CardTitle" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="CardDescription"></label>
        <textarea asp-for="CardDescription" class="form-control"></textarea>
    </div>

    <div class="form-group form-check">
        <input asp-for="IsPublic" class="form-check-input" />
        <label asp-for="IsPublic" class="form-check-label">Công khai</label>
    </div>

    <div class="form-group">
        <label asp-for="DeckId"></label>
        <select asp-for="DeckId" asp-items="ViewBag.DeckId" class="form-control"></select>
    </div>

    <hr />
    <h4>Các cặp từ trong Flashcard</h4>

    <div id="cardPairsContainer">
        @for (int i = 0; i < Model.CardPairs.Count; i++)
        {
            <div class="card-pair mb-2 p-2 border border-2">
                <input type="hidden" asp-for="CardPairs[@i].PairId" />
                <div class="form-group">
                    <label>Front</label>
                    <input asp-for="CardPairs[@i].FrontCard" class="form-control" />
                </div>
                <div class="form-group">
                    <label>Back</label>
                    <input asp-for="CardPairs[@i].BackCard" class="form-control" />
                </div>
                <button type="button" class="btn btn-danger removePair mt-1">Xóa</button>
            </div>
        }
    </div>

    <button type="button" id="addPairBtn" class="btn btn-secondary mt-2">+ Thêm cặp mới</button>

    <div class="form-group mt-3">
        <input type="submit" value="Lưu thay đổi" class="btn btn-primary" />
    </div>
</form>
<script>
    const container = document.getElementById("cardPairsContainer");
    const addBtn = document.getElementById("addPairBtn");

    function reindexPairs() {
        const pairs = container.querySelectorAll(".card-pair");
        pairs.forEach((pair, i) => {
            pair.querySelectorAll("input").forEach(input => {
                input.name = input.name.replace(/\[\d+\]/, `[${i}]`);
            });
        });
    }

    function addRemoveEvent(btn) {
        btn.addEventListener("click", e => {
            e.target.closest(".card-pair").remove();
            reindexPairs();
        });
    }

    // Thêm sự kiện xóa cho cặp hiện có
    document.querySelectorAll(".removePair").forEach(addRemoveEvent);

    addBtn.addEventListener("click", function () {
        const index = container.children.length;
        const div = document.createElement("div");
        div.classList.add("card-pair");
        div.innerHTML = `
            <label>Front</label>
            <input name="CardPairs[${index}].FrontCard" class="form-control" />
            <label>Back</label>
            <input name="CardPairs[${index}].BackCard" class="form-control" />
            <button type="button" class="btn btn-danger removePair mt-1">Xóa</button>
            <hr/>
        `;
        container.append(div);
        addRemoveEvent(div.querySelector(".removePair"));
        reindexPairs();
    });

</script>
@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}